name: hwci

on:
  push:
    branches: ["**"]
  pull_request:
    branches: ["**"]

jobs:
  verilator-regression:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout RTL repo
        uses: actions/checkout@v4

      - name: Install Verilator
        run: sudo apt-get update && sudo apt-get install -y verilator git

      - name: Checkout hw_ci
        uses: actions/checkout@v4
        with:
          repository: ewoldege/hw_ci
          ref: main
          path: hw_ci

      - name: Run hwci
        run: |
          start_ts=$(date +%s)
          python3 hw_ci/runner/hwci.py run \
            --repo ${{ github.server_url }}/${{ github.repository }}.git \
            --sha ${{ github.sha }} \
            --plan plan.json \
            --out out_dir
          end_ts=$(date +%s)
          echo "HWCI_START_TS=$start_ts" >> "$GITHUB_ENV"
          echo "HWCI_END_TS=$end_ts" >> "$GITHUB_ENV"

      - name: Publish job summary
        if: always()
        run: |
          {
            echo "## HWCI Results"
            if [ -f out_dir/results.json ]; then
              echo ""
              echo "\`out_dir/results.json\`:"
              echo ""
              cat out_dir/results.json
            else
              echo ""
              echo "No results.json found."
            fi
          } >> "$GITHUB_STEP_SUMMARY"
          python3 - <<'PY' >> "$GITHUB_STEP_SUMMARY"
import json
import os
from datetime import datetime

def parse_ts(ts):
    return datetime.fromisoformat(ts.replace("Z", "+00:00"))

print("\n## Performance Metrics")
start = os.environ.get("HWCI_START_TS")
end = os.environ.get("HWCI_END_TS")
if start and end:
    total = int(end) - int(start)
    print(f"- Total wall time (s): {total}")
path = "out_dir/results.json"
if os.path.exists(path):
    with open(path, "r", encoding="ascii") as handle:
        data = json.load(handle)
    for stage in data.get("stages", []):
        s = stage.get("started_at")
        f = stage.get("finished_at")
        if s and f:
            dur = (parse_ts(f) - parse_ts(s)).total_seconds()
            print(f"- {stage.get('name','stage')} duration (s): {int(dur)}")
PY

      - name: Upload artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: hwci-artifacts
          path: out_dir
